<!DOCTYPE html>
<html lang="es">
<head>
Â  <meta charset="UTF-8" />
Â  <title>ASV DApp â€” Living Avatar Web3</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />

Â  Â  <script src="https://cdn.ethers.io/lib/ethers-5.7.umd.min.js"></script>

Â  <style>
Â  Â  :root{
Â  Â  Â  --bg-dark:#0e0f12;--bg-light:#f5f7fb;--text-dark:#e9edf3;--text-light:#1c2333;
Â  Â  Â  --primary:#00bcd4;--secondary:#1a1f2e;--error:#ef4444;--success:#22c55e;--warning:#f59e0b;
Â  Â  Â  --card:#151a26;--border:#2a2f3f;
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg-dark);color:var(--text-dark);min-height:100vh;display:flex}
Â  Â  body.light{background:var(--bg-light);color:var(--text-light)}
Â  Â  .shell{width:100%;max-width:980px;margin:auto;display:flex;flex-direction:column;gap:14px;padding:16px}
Â  Â  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.35)}
Â  Â  body.light .card{background:white;border-color:#e6e8ef}
Â  Â  header.card{padding:16px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
Â  Â  .title{display:flex;align-items:center;gap:10px}
Â  Â  .title h1{font-size:18px;margin:0}
Â  Â  .tag{font-size:12px;padding:2px 8px;border-radius:999px;background:rgba(0,188,212,.15);color:#8beaf5;border:1px solid rgba(0,188,212,.35)}
Â  Â  body.light .tag{background:#e6fbff;color:#0e6b77;border-color:#b6f3fb}
Â  Â  .actions{display:flex;gap:10px}
Â  Â  .btn{border:1px solid var(--border);background:var(--secondary);color:var(--text-dark);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
Â  Â  .btn.primary{background:var(--primary);color:#052229;border:none}
Â  Â  .btn.wallet{background:#f6851b;color:white;border:none}
Â  Â  .btn:disabled{opacity:.6;cursor:not-allowed}
Â  Â  body.light .btn{background:#f0f2f8;border-color:#e2e6f2;color:#1f2433}
Â  Â  .vitality-wrap{width:100%;margin-top:10px}
Â  Â  .vitality{height:12px;background:#111827;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
Â  Â  .vitality>div{height:100%;width:35%;background:linear-gradient(90deg,#00bcd4,#4ade80);transition:width .6s ease, background .3s}
Â  Â  body.light .vitality{background:#eef1f7}
Â  Â  /* grid */
Â  Â  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
Â  Â  @media (max-width:900px){.grid{grid-template-columns:1fr}}
Â  Â  /* chat */
Â  Â  .chat.card{display:flex;flex-direction:column;height:500px;overflow:hidden}
Â  Â  .chat-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
Â  Â  .history{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px;background:radial-gradient(1200px 300px at 20% -10%,rgba(0,188,212,.06),transparent)}
Â  Â  .msg{max-width:78%;padding:10px 14px;border-radius:14px;line-height:1.45;font-size:14px}
Â  Â  .msg .ts{opacity:.65;font-size:11px;margin-right:6px}
Â  Â  .msg.user{align-self:flex-end;background:var(--primary);color:#06252a;border-bottom-right-radius:6px}
Â  Â  .msg.bot{align-self:flex-start;background:#101623;border:1px solid var(--border);border-bottom-left-radius:6px}
Â  Â  body.light .msg.bot{background:#f7f9ff;border-color:#e6e8ef}
Â  Â  .composer{display:flex;gap:8px;padding:12px;border-top:1px solid var(--border)}
Â  Â  input[type=text]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid var(--border);background:#0e1320;color:var(--text-dark)}
Â  Â  body.light input[type=text]{background:white;color:#1a2233;border-color:#dfe3ef}
Â  Â  /* payments */
Â  Â  .payments.card{padding:14px;display:flex;flex-direction:column;gap:10px}
Â  Â  .pay-head{display:flex;align-items:center;gap:8px}
Â  Â  .pay-form{display:none;flex-direction:column;gap:10px;border-top:1px dashed var(--border);padding-top:10px}
Â  Â  .row{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center}
Â  Â  .row input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:#0e1320;color:var(--text-dark)}
Â  Â  body.light .row input{background:#fff;color:#1c2233;border-color:#dfe3ef}
Â  Â  .muted{opacity:.8;font-size:12px}
Â  Â  
Â  Â  /* ESTILOS DINÃMICOS DEL AVATAR */
Â  Â  .face.card{padding:14px;display:flex;align-items:center;gap:14px}
Â  Â  .canvas-wrap{
Â  Â  Â  position:relative;width:120px;height:120px;border-radius:50%;overflow:hidden;border:1px solid var(--border);
Â  Â  Â  /* **IMPORTANTE: Reemplaza esta URL con la imagen de tu avatar (e.g., matrix azul)** */
Â  Â  Â  background:url('https://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Digital_face.jpg/1200px-Digital_face.jpg') no-repeat center center; 
Â  Â  Â  background-size: cover;
Â  Â  Â  transition: filter 0.8s ease-in-out, transform 0.2s; 
Â  Â  Â  box-shadow: 0 0 20px rgba(0, 188, 212, 0.5);
Â  Â  }
Â  Â  #face-overlay { 
Â  Â  Â  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
Â  Â  Â  background-color: rgba(0, 0, 0, 0);
Â  Â  Â  border-radius: 50%;
Â  Â  Â  transition: background-color 0.1s;
Â  Â  }
Â  Â  canvas#face{display:none} /* Ocultamos el canvas 2D simple */

Â  Â  .face-info{display:flex;flex-direction:column;gap:6px}
Â  Â  /* notifications */
Â  Â  #toasts{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
Â  Â  .toast{padding:10px 14px;border-radius:10px;color:#041316;box-shadow:0 6px 20px rgba(0,0,0,.35);transform:translateX(120%);opacity:0;transition:.35s}
Â  Â  .toast.show{transform:none;opacity:1}
Â  Â  .t-info{background:#67e8f9}.t-success{background:#86efac}.t-warn{background:#fde68a}.t-err{background:#fca5a5}
Â  </style>
</head>
<body>
Â  <div class="shell">
Â  Â  Â  Â  <header class="card">
Â  Â  Â  <div class="title">
Â  Â  Â  Â  <h1>ğŸ¤– ASV DApp</h1>
Â  Â  Â  Â  <span class="tag">Living Avatar Â· Web3</span>
Â  Â  Â  </div>
Â  Â  Â  <div class="actions">
Â  Â  Â  Â  <button id="btn-theme" class="btn">ğŸŒ™ Tema</button>
Â  Â  Â  Â  <button id="btn-connect" class="btn wallet">ğŸ”— Conectar Wallet</button>
Â  Â  Â  </div>
Â  Â  Â  <div class="vitality-wrap" style="grid-column:1/-1">
Â  Â  Â  Â  <div class="vitality"><div id="vitality-bar" style="width:32%"></div></div>
Â  Â  Â  Â  <div class="muted" id="vitality-label" style="margin-top:6px">Vitalidad: 32%</div>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div class="grid">
Â  Â  Â  Â  Â  Â  <section class="chat card">
Â  Â  Â  Â  <div class="chat-head">
Â  Â  Â  Â  Â  <strong>Chat con ASV</strong>
Â  Â  Â  Â  Â  <span class="muted" id="addr-label">Wallet: â€”</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="history" class="history"></div>
Â  Â  Â  Â  <div class="composer">
Â  Â  Â  Â  Â  <input id="prompt" type="text" placeholder="Escribe aquÃ­â€¦ (p. ej. 'recargar vitalidad')" maxlength="500" />
Â  Â  Â  Â  Â  <button id="btn-send" class="btn primary">Enviar</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <aside class="right">
Â  Â  Â  Â  <div class="face card">
Â  Â  Â  Â  Â  <div class="canvas-wrap">
Â  Â  Â  Â  Â  Â  <canvas id="face" width="240" height="240"></canvas>
Â  Â  Â  Â  Â  Â  <div id="face-overlay"></div> Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="face-info">
Â  Â  Â  Â  Â  Â  <div><strong>Estado:</strong> <span id="state-text">inicializandoâ€¦</span></div>
Â  Â  Â  Â  Â  Â  <div><strong>EmociÃ³n:</strong> <span id="emotion-text">idle</span></div>
Â  Â  Â  Â  Â  Â  <div class="muted">Los microgestos y la mirada cambian con la vitalidad.</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="payments card">
Â  Â  Â  Â  Â  <div class="pay-head">
Â  Â  Â  Â  Â  Â  <strong>ğŸ’³ Recarga / Pago ASV</strong>
Â  Â  Â  Â  Â  Â  <span class="muted">Token: <code id="token-addr">â€”</code></span>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="pay-form" class="pay-form">
Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  <label>RazÃ³n</label>
Â  Â  Â  Â  Â  Â  Â  <input id="pay-reason" type="text" readonly />
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  <label>Destinatario</label>
Â  Â  Â  Â  Â  Â  Â  <input id="pay-to" type="text" readonly />
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  Â  <label>Cantidad (ASV)</label>
Â  Â  Â  Â  Â  Â  Â  <input id="pay-amount" type="text" readonly />
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button id="btn-pay" class="btn primary">âœ… Confirmar Pago</button>
Â  Â  Â  Â  Â  Â  <div class="muted">Se abrirÃ¡ MetaMask; al confirmar, la vitalidad subirÃ¡.</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="pay-hint" class="muted">El avatar mostrarÃ¡ aquÃ­ el formulario cuando sugiera recargar.</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </aside>
Â  Â  </div>
Â  </div>

Â  Â  <div id="toasts"></div>

Â  <script>
Â  Â  // ========= CONFIG =========
Â  Â  const API_ENDPOINT = "http://localhost:5000/api/ai-response"; // Flask/Backend de IA
Â  Â  const TOKEN_ADDRESS = "0x2682FA44105a60F2016FAa8909eA82d3d427bfFc"; // Contrato del Token ASV
Â  Â  const DEFAULT_DECIMALS = 18;

Â  Â  // ========= STATE =========
Â  Â  const state = {
Â  Â  Â  provider: null,
Â  Â  Â  signer: null,
Â  Â  Â  account: null,
Â  Â  Â  token: null,
Â  Â  Â  tokenDecimals: DEFAULT_DECIMALS,
Â  Â  Â  isSending: false,
Â  Â  Â  history: []
Â  Â  };

Â  Â  // ========= UI HELPERS =========
Â  Â  const $ = (id)=>document.getElementById(id);
Â  Â  const addToast = (msg, kind='t-info', ms=4000)=>{
Â  Â  Â  const n=document.createElement('div'); n.className=`toast ${kind}`; n.textContent=msg;
Â  Â  Â  $('toasts').appendChild(n); requestAnimationFrame(()=>n.classList.add('show'));
Â  Â  Â  setTimeout(()=>{n.classList.remove('show'); n.addEventListener('transitionend',()=>n.remove())}, ms);
Â  Â  };
Â  Â  const ts = ()=>new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
Â  Â  const pushMsg = (role, content)=>{
Â  Â  Â  state.history.push({role, content, timestamp:ts()});
Â  Â  Â  const d = document.createElement('div'); d.className=`msg ${role}`;
Â  Â  Â  d.innerHTML = `<span class="ts">${ts()}:</span> ${content}`;
Â  Â  Â  $('history').appendChild(d); $('history').scrollTop = $('history').scrollHeight;
Â  Â  };

Â  Â  // ========= THEME =========
Â  Â  $('btn-theme').addEventListener('click',()=>{
Â  Â  Â  document.body.classList.toggle('light');
Â  Â  Â  addToast(`Tema ${document.body.classList.contains('light')?'claro':'oscuro'} activado`,'t-info');
Â  Â  });

Â  Â  // ========= VITALITY + EMOTION =========
Â  Â  function setVitality(p){
Â  Â  Â  const v = Math.max(0, Math.min(100, Math.round(p)));
Â  Â  Â  $('vitality-bar').style.width = v+'%';
Â  Â  Â  $('vitality-label').textContent = `Vitalidad: ${v}%`;
Â  Â  Â  if (v < 25) $('vitality-bar').style.background = 'linear-gradient(90deg,#ef4444,#f59e0b)';
Â  Â  Â  else if (v < 50) $('vitality-bar').style.background = 'linear-gradient(90deg,#f59e0b,#fde047)';
Â  Â  Â  else $('vitality-bar').style.background = 'linear-gradient(90deg,#00bcd4,#4ade80)';
Â  Â  Â  drawFace(v);
Â  Â  Â  setEmotion(v);
Â  Â  }
Â  Â  function setEmotion(v){
Â  Â  Â  const e = v>70?'happy':(v>=40?'neutral':(v>=20?'tired':'low'));
Â  Â  Â  $('emotion-text').textContent = e;
Â  Â  }

Â  Â  // ========= AVATAR FACE (SIMULACIÃ“N DE GESTOS EN IMAGEN) =========
Â  Â  const faceWrap = document.querySelector('.canvas-wrap');
Â  Â  const faceOverlay = $('face-overlay');
Â  Â  let blinkTimer = 0;
Â  Â  
Â  Â  function drawFace(vital=40){
Â  Â  Â  // 1. SimulaciÃ³n de Vitalidad con Filtros CSS
Â  Â  Â  // MÃ¡s vital -> mÃ¡s brillo y contraste
Â  Â  Â  let brightness = 1 + (vital - 50) / 100 * 0.4; 
Â  Â  Â  let contrast = 1 + (vital - 50) / 100 * 0.2; 

Â  Â  Â  faceWrap.style.filter = `brightness(${brightness}) contrast(${contrast})`;
Â  Â  Â  
Â  Â  Â  // 2. SimulaciÃ³n de Estado (Sacudida/Pulso)
Â  Â  Â  if (vital < 20) {
Â  Â  Â  Â  // PequeÃ±o temblor cuando la vitalidad es crÃ­tica
Â  Â  Â  Â  faceWrap.style.transform = `scale(0.98) rotate(${Math.sin(Date.now()/50) * 0.5}deg)`;
Â  Â  Â  } else {
Â  Â  Â  Â  faceWrap.style.transform = `scale(1)`;
Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // Nueva funciÃ³n de animaciÃ³n para parpadeo y efectos continuos
Â  Â  function animate(){
Â  Â  Â  blinkTimer+=1;
Â  Â  Â  
Â  Â  Â  // SimulaciÃ³n de parpadeo suave con opacidad del overlay
Â  Â  Â  const blink = (Math.sin(blinkTimer/15)+1)/2; // 0..1
Â  Â  Â  // MÃ¡s opaco el parpadeo si la vitalidad estÃ¡ baja (mÃ¡s 'pesados' los pÃ¡rpados)
Â  Â  Â  const eyeClose = Math.pow(blink, 8) * (faceWrap.style.filter.includes('brightness(1') ? 0.9 : 0.6);
Â  Â  Â  
Â  Â  Â  if (eyeClose > 0.4) {
Â  Â  Â  Â  faceOverlay.style.backgroundColor = `rgba(0, 0, 0, ${eyeClose})`;
Â  Â  Â  } else {
Â  Â  Â  Â  faceOverlay.style.backgroundColor = `rgba(0, 0, 0, 0)`;
Â  Â  Â  }

Â  Â  Â  // Redibujamos la cara en cada frame para capturar el temblor
Â  Â  Â  const curr = parseInt($('vitality-label').textContent.replace(/\D/g,''))||32;
Â  Â  Â  drawFace(curr);
Â  Â  Â  
Â  Â  Â  requestAnimationFrame(animate);
Â  Â  }
Â  Â  
Â  Â  animate(); 
Â  Â  drawFace(32); // Inicializa con vitalidad base

Â  Â  // ========= WALLET =========
Â  Â  async function ensureProvider(){
Â  Â  Â  if(!window.ethereum){ addToast("Instala MetaMask para usar la DApp.","t-err",6000); return false; }
Â  Â  Â  if(!state.provider){ state.provider = new ethers.providers.Web3Provider(window.ethereum); }
Â  Â  Â  return true;
Â  Â  }
Â  Â  async function connect(){
Â  Â  Â  if(!(await ensureProvider())) return;
Â  Â  Â  try{
Â  Â  Â  Â  const accounts = await window.ethereum.request({method:'eth_requestAccounts'});
Â  Â  Â  Â  state.account = accounts[0] || null;
Â  Â  Â  Â  $('addr-label').textContent = 'Wallet: ' + (state.account ? state.account.slice(0,8)+'â€¦'+state.account.slice(-4) : 'â€”');
Â  Â  Â  Â  $('btn-connect').textContent = state.account ? 'âœ… Conectado' : 'ğŸ”— Conectar Wallet';
Â  Â  Â  Â  $('btn-connect').disabled = !!state.account;
Â  Â  Â  Â  state.signer = state.provider.getSigner();
Â  Â  Â  Â  await setupToken();
Â  Â  Â  Â  addToast('Wallet conectada.','t-success');
Â  Â  Â  Â  pushMsg('bot','Wallet conectada. Estoy listo para operar con tu token ASV.');
Â  Â  Â  Â  // Vitalidad basada en saldo
Â  Â  Â  Â  await syncVitalityByBalance();
Â  Â  Â  }catch(e){ addToast('ConexiÃ³n cancelada o fallida.','t-err'); }
Â  Â  }
Â  Â  async function setupToken(){
Â  Â  Â  state.token = new ethers.Contract(TOKEN_ADDRESS, [
Â  Â  Â  Â  "function balanceOf(address) view returns (uint256)",
Â  Â  Â  Â  "function transfer(address to, uint256 amount) returns (bool)",
Â  Â  Â  Â  "function decimals() view returns (uint8)"
Â  Â  Â  ], state.signer || state.provider);
Â  Â  Â  $('token-addr').textContent = TOKEN_ADDRESS;
Â  Â  Â  try{
Â  Â  Â  Â  state.tokenDecimals = parseInt(await state.token.decimals()) || DEFAULT_DECIMALS;
Â  Â  Â  }catch{ state.tokenDecimals = DEFAULT_DECIMALS; }
Â  Â  }
Â  Â  async function tokenBalanceOf(addr){
Â  Â  Â  if(!state.token) return 0;
Â  Â  Â  try{
Â  Â  Â  Â  const raw = await state.token.balanceOf(addr);
Â  Â  Â  Â  return parseFloat(ethers.utils.formatUnits(raw, state.tokenDecimals));
Â  Â  Â  }catch{ return 0; }
Â  Â  }
Â  Â  async function syncVitalityByBalance(){
Â  Â  Â  if(!state.account) return;
Â  Â  Â  const bal = await tokenBalanceOf(state.account);
Â  Â  Â  // Umbral: 1000 tokens = 100% vitalidad
Â  Â  Â  const pct = Math.max(5, Math.min(100, Math.round((bal/1000)*100)));
Â  Â  Â  setVitality(pct);
Â  Â  Â  $('state-text').textContent = 'operativo';
Â  Â  }

Â  Â  // ========= BACKEND CHAT =========
Â  Â  async function askBackend(userText){
Â  Â  Â  if(!state.account){ pushMsg('bot','Conecta tu wallet para continuar.'); return; }
Â  Â  Â  const context = state.history.slice(-10).map(m=>({role:m.role==='user'?'user':'avatar', content:m.content}));
Â  Â  Â  const payload = { input: userText, account: state.account, context };
Â  Â  Â  try{
Â  Â  Â  Â  const res = await fetch(API_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  if(!res.ok){ throw new Error(data?.error || 'HTTP '+res.status); }
Â  Â  Â  Â  // pintar respuesta
Â  Â  Â  Â  const text = data.text_response || 'â€¦';
Â  Â  Â  Â  pushMsg('bot', text);
Â  Â  Â  Â  // vitalidad
Â  Â  Â  Â  if(typeof data.vitality_status === 'number') setVitality(data.vitality_status);
Â  Â  Â  Â  // acciÃ³n de pago
Â  Â  Â  Â  if(data.action_type === 'suggest_payment' && data.payment_details){
Â  Â  Â  Â  Â  const { recipient_address, amount_asv_a, reason } = data.payment_details;
Â  Â  Â  Â  Â  showPaymentForm(recipient_address || TOKEN_ADDRESS, amount_asv_a ?? 10, reason || 'Recarga de Vitalidad');
Â  Â  Â  Â  }else{
Â  Â  Â  Â  Â  hidePaymentForm();
Â  Â  Â  Â  }
Â  Â  Â  }catch(e){
Â  Â  Â  Â  pushMsg('bot','Error de IA. Intenta de nuevo o verifica el servidor.');
Â  Â  Â  Â  addToast('Fallo al contactar el backend.','t-err',5000);
Â  Â  Â  }
Â  Â  }

Â  Â  // ========= PAYMENTS =========
Â  Â  function showPaymentForm(recipient, amount, reason){
Â  Â  Â  $('pay-hint').style.display='none';
Â  Â  Â  $('pay-form').style.display='flex';
Â  Â  Â  $('pay-to').value = recipient;
Â  Â  Â  $('pay-amount').value = amount;
Â  Â  Â  $('pay-reason').value = reason;
Â  Â  }
Â  Â  function hidePaymentForm(){
Â  Â  Â  $('pay-form').style.display='none';
Â  Â  Â  $('pay-hint').style.display='block';
Â  Â  }
Â  Â  async function confirmPayment(){
Â  Â  Â  if(!state.account || !state.signer || !state.token){ addToast('Conecta tu wallet primero.','t-err'); return; }
Â  Â  Â  if(state.isSending) return;
Â  Â  Â  state.isSending = true; $('btn-pay').disabled = true;
Â  Â  Â  try{
Â  Â  Â  Â  const to = $('pay-to').value.trim();
Â  Â  Â  Â  const amt = $('pay-amount').value.trim();
Â  Â  Â  Â  if(!ethers.utils.isAddress(to)) throw new Error('DirecciÃ³n invÃ¡lida');
Â  Â  Â  Â  const value = ethers.utils.parseUnits(String(amt), state.tokenDecimals);
Â  Â  Â  Â  addToast('Confirmar transacciÃ³n en MetaMaskâ€¦','t-info');
Â  Â  Â  Â  const tx = await state.token.transfer(to, value);
Â  Â  Â  Â  await tx.wait();
Â  Â  Â  Â  addToast('Pago confirmado âœ…','t-success',5000);
Â  Â  Â  Â  pushMsg('bot', `Â¡Gracias! RecibÃ­ ${amt} ASV. Mi vitalidad aumenta.`);
Â  Â  Â  Â  // Aumenta la vitalidad con el pago
Â  Â  Â  Â  const curr = parseInt($('vitality-label').textContent.replace(/\D/g,''))||35;
Â  Â  Â  Â  setVitality(Math.min(100, curr + 20));
Â  Â  Â  Â  hidePaymentForm();
Â  Â  Â  }catch(e){
Â  Â  Â  Â  addToast(e?.message?.includes('rejected')?'TransacciÃ³n rechazada.':'Error al enviar pago.','t-err',6000);
Â  Â  Â  }finally{
Â  Â  Â  Â  state.isSending = false; $('btn-pay').disabled = false;
Â  Â  Â  }
Â  Â  }

Â  Â  // ========= EVENTS =========
Â  Â  $('btn-connect').addEventListener('click', connect);
Â  Â  $('btn-pay').addEventListener('click', confirmPayment);
Â  Â  $('btn-send').addEventListener('click', ()=>{
Â  Â  Â  const v = $('prompt').value.trim(); if(!v) return;
Â  Â  Â  $('prompt').value=''; pushMsg('user', v);
Â  Â  Â  // comando rÃ¡pido para recarga
Â  Â  Â  if(v.toLowerCase().includes('recargar')){
Â  Â  Â  Â  showPaymentForm(TOKEN_ADDRESS, 10, 'Recarga de Vitalidad ASV');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  askBackend(v);
Â  Â  Â  // desgaste natural mÃ­nimo por interacciÃ³n
Â  Â  Â  const curr = parseInt($('vitality-label').textContent.replace(/\D/g,''))||32;
Â  Â  Â  setVitality(Math.max(5, curr-3));
Â  Â  });
Â  Â  $('prompt').addEventListener('keypress',(e)=>{ if(e.key==='Enter') $('btn-send').click(); });

Â  Â  // auto init
Â  Â  pushMsg('bot','Â¡Bienvenido! Soy tu Avatar Viviente ASV. Conecta tu wallet y conversemos.');
Â  Â  setVitality(32);
Â  Â  $('state-text').textContent = 'listo';

Â  Â  // provider listeners
Â  Â  if(window.ethereum){
Â  Â  Â  window.ethereum.on('accountsChanged', (acc)=>{
Â  Â  Â  Â  state.account = acc?.[0]||null;
Â  Â  Â  Â  $('addr-label').textContent = 'Wallet: ' + (state.account ? state.account.slice(0,8)+'â€¦'+state.account.slice(-4) : 'â€”');
Â  Â  Â  Â  if(state.account){ state.signer = state.provider.getSigner(); setupToken().then(syncVitalityByBalance); }
Â  Â  Â  Â  else { addToast('Wallet desconectada.','t-warn'); }
Â  Â  Â  });
Â  Â  Â  window.ethereum.on('chainChanged', ()=>location.reload());
Â  Â  Â  // intento de autoconexiÃ³n
Â  Â  Â  window.ethereum.request({method:'eth_accounts'}).then(acc=>{
Â  Â  Â  Â  if(acc.length){ state.account = acc[0]; $('btn-connect').click(); }
Â  Â  Â  }).catch(()=>{});
Â  Â  } else {
Â  Â  Â  addToast('Necesitas MetaMask u otra wallet Web3.','t-err',8000);
Â  Â  }
Â  </script>
</body>
</html>
